# TabTaskTick Phase 2 - Session Context

## Current Status Summary

**Project**: TabTaskTick v1.3.0 - Evolution of TabMaster Pro into Collections + Tasks system
**Phase**: Phase 2 - Core Services (In Progress)
**Branch**: `main`
**Last Updated**: October 15, 2025

### What's Complete âœ…

#### Phase 1: IndexedDB Foundation (100% Complete)
- Database schema with 4 normalized object stores (collections, folders, tabs, tasks)
- Storage utilities: `/services/utils/db.js` (398 lines), `/services/utils/storage-queries.js` (700+ lines)
- Jest unit tests: 36/38 passing (95% pass rate)
- Known issue: 2 tests failing due to fake-indexeddb index query bug (see below)

#### Phase 2.1: Selection Services (100% Complete)
- **Selection Services Implemented**:
  - `/services/selection/selectCollections.js` (220 lines) - Query collections with filters
  - `/services/selection/selectTasks.js` (250 lines) - Query tasks with compound filters
- **Integration Tests Written** (702 lines, 47 tests):
  - `/tests/selectCollections.test.js` (305 lines, 23 tests)
  - `/tests/selectTasks.test.js` (397 lines, 24 tests)
- **âš ï¸ Tests Cannot Validate Index Queries**: fake-indexeddb v6.2.3 has critical bug where `index.getAll(key)` returns `[]` even with valid data in Jest+jsdom+ES modules environment

#### Phase 2.1.5: E2E Testing Infrastructure (100% Complete) ðŸŽ‰
- **Problem Solved**: Migrated from fake-indexeddb to Playwright for real browser testing
- **Playwright Setup**:
  - Installed: `@playwright/test` v1.56.0 + Chromium browser
  - Config: `/playwright.config.js` - Chrome extension testing
  - Fixtures: `/tests/e2e/fixtures/extension.js` - Extension loading utilities
  - Test page: `/test-page.html` - For ES module imports
- **Smoke Tests**: 3/3 passing âœ…
  - Extension loads correctly
  - Service worker accessible
  - Chrome APIs available
- **Documentation**: `/docs/playwright-testing.md` (complete guide)
- **NPM Scripts**: `test:e2e`, `test:e2e:ui`, `test:e2e:headed`, `test:e2e:debug`

### What's Next ðŸŽ¯

#### Immediate Next Step: Write Playwright E2E Tests for Selection Services
**Priority**: HIGH (blocks Phase 2.2)
**Estimate**: 2-3 hours

**Why Critical**: Selection services rely on IndexedDB index queries which failed in fake-indexeddb. Must validate with real Chrome IndexedDB before proceeding to Phase 2.2.

**Tasks**:
1. Create `/tests/e2e/selectCollections.spec.js`
   - Test `selectCollections()` with various filters (isActive, tags, search, date ranges)
   - Validate index queries return correct results
   - Test sorting (lastAccessed, createdAt, name)

2. Create `/tests/e2e/selectTasks.spec.js`
   - Test `selectTasks()` with compound filters (collectionId, status, priority, tags, due dates)
   - Validate multi-index queries work correctly
   - Test priority sorting and due date handling

**Pattern to Follow**: See `/tests/e2e/extension-loads.spec.js` and use the `testPage` fixture (not `serviceWorkerPage` - service workers don't support dynamic imports).

#### After E2E Tests: Phase 2.2 - CollectionService (3-4 hours)
- Create `/services/execution/CollectionService.js` (~300 lines)
- Implement CRUD operations calling storage utilities
- Window binding: `bindToWindow()`, `unbindFromWindow()`
- Jest unit tests with mocked storage utilities (~30 tests)

---

## Critical Technical Details

### Architecture Constraints (NON-NEGOTIABLE)

1. **No Dynamic Imports in Service Workers**: Chrome service workers don't support `import()`. Use `testPage` fixture for E2E tests that need ES modules.

2. **Services-First Architecture**:
   - All business logic in `/services/*`
   - Storage utilities in `/services/utils/*` (not services!)
   - UI surfaces are THIN presentation layers

3. **Separation of Concerns**:
   - **Selection services**: Read-only filtering (what to act on)
   - **Execution services**: State modification (how to act)
   - **Storage utilities**: CRUD operations (data access)

4. **Normalized Data Model**: 4 separate IndexedDB stores with foreign keys (not nested documents). Avoids race conditions.

### Testing Strategy

**Jest Unit Tests** (for logic that doesn't need IndexedDB indexes):
- CRUD operations with storage utilities
- Business logic validation
- Error handling
- Service operations with mocked dependencies

**Playwright E2E Tests** (for IndexedDB index queries):
- Selection services (CRITICAL - index queries must work)
- Window lifecycle operations
- Cascade deletes with real IndexedDB
- Integration workflows

**Current Test Status**:
- Jest: 36/38 passing (95%), 2 failures due to fake-indexeddb index bug
- Playwright: 3/3 smoke tests passing âœ…
- **Needed**: E2E tests for selectCollections/selectTasks (~50 tests)

### Known Issues & Solutions

#### Issue 1: fake-indexeddb Index Queries Return Empty Arrays
**Symptom**: `index.getAll(key)` returns `[]` in Jest tests even with valid data
**Root Cause**: Compatibility issue with Jest ES modules + jsdom + fake-indexeddb v6.2.3
**Impact**: Cannot validate selection services (core functionality)
**Solution**: âœ… Migrated to Playwright for real Chrome IndexedDB
**Status**: SOLVED - Playwright infrastructure complete

#### Issue 2: Service Worker Dynamic Imports Not Allowed
**Symptom**: `TypeError: import() is disallowed on ServiceWorkerGlobalScope`
**Root Cause**: Chrome service workers don't support dynamic `import()`
**Solution**: Use `testPage` fixture which loads `/test-page.html` (regular page context supports imports)
**Status**: SOLVED - documented in `/docs/playwright-testing.md`

#### Issue 3: Chrome Profile Conflicts in Parallel Tests
**Symptom**: `Failed to create a ProcessSingleton for your profile directory`
**Root Cause**: Multiple Playwright tests trying to use same Chrome profile simultaneously
**Solution**: Set `workers: 1` in `playwright.config.js` for sequential execution
**Status**: SOLVED - configured in playwright.config.js

---

## Key Files & Locations

### Services (Implemented)
```
services/
â”œâ”€â”€ selection/
â”‚   â”œâ”€â”€ selectCollections.js (220 lines) âœ…
â”‚   â””â”€â”€ selectTasks.js (250 lines) âœ…
â””â”€â”€ utils/
    â”œâ”€â”€ db.js (398 lines) âœ…
    â””â”€â”€ storage-queries.js (700+ lines) âœ…
```

### Tests
```
tests/
â”œâ”€â”€ db.test.js (631 lines, 29 tests) âœ… 26/29 passing
â”œâ”€â”€ storage-queries.test.js (1013 lines, 38 tests) âœ… 36/38 passing
â”œâ”€â”€ selectCollections.test.js (305 lines, 23 tests) âš ï¸ Need E2E validation
â”œâ”€â”€ selectTasks.test.js (397 lines, 24 tests) âš ï¸ Need E2E validation
â””â”€â”€ e2e/
    â”œâ”€â”€ fixtures/
    â”‚   â””â”€â”€ extension.js (119 lines) âœ…
    â”œâ”€â”€ extension-loads.spec.js (41 lines, 3/3 passing) âœ…
    â”œâ”€â”€ indexeddb-basic.spec.js (template) âš ï¸ Needs completion
    â””â”€â”€ test-page.spec.js (template)
```

### Documentation
```
docs/
â”œâ”€â”€ tabtasktick-data-models-v2.md âœ…
â”œâ”€â”€ playwright-testing.md âœ… Complete guide
â””â”€â”€ service-dependencies.md (existing TabMaster docs)

plans/
â””â”€â”€ TABTASKTICK-PRODUCT-PROPOSAL-V3.md âœ… Updated with Phase 1.5

../TODO.md âœ… Updated with current status
```

### Configuration
```
playwright.config.js âœ…
test-page.html âœ…
package.json - Added test:e2e* scripts âœ…
```

---

## Development Commands

### Testing
```bash
# Jest unit tests (existing TabMaster + Phase 1)
npm test                    # Run all Jest tests
npm run test:watch          # Watch mode

# Playwright E2E tests (NEW)
npm run test:e2e            # Run all E2E tests
npm run test:e2e:ui         # Interactive UI mode
npm run test:e2e:headed     # Watch in browser (visible)
npm run test:e2e:debug      # Step-through debugger
npm run test:e2e:report     # View HTML report

# Run specific test
npx playwright test tests/e2e/extension-loads.spec.js
```

### Cleanup
```bash
# Clean Playwright artifacts
rm -rf .playwright-user-data test-results playwright-report
```

---

## Code Patterns & Examples

### Writing Playwright E2E Tests for IndexedDB

```javascript
import { test, expect } from './fixtures/extension.js';

test('index queries work correctly', async ({ testPage }) => {
  const result = await testPage.evaluate(async () => {
    // Import ES modules (works in page context, not service worker!)
    const { saveCollection, getCollectionsByIndex } =
      await import('./services/utils/storage-queries.js');
    const { clearAllData } = await import('./services/utils/db.js');

    // Clear existing data
    await clearAllData();

    // Save test data
    await saveCollection({
      id: 'active_1',
      name: 'Active Collection',
      isActive: true,
      tags: ['work'],
      metadata: { createdAt: Date.now(), lastAccessed: Date.now() }
    });

    // Query using index (THIS IS WHAT WE NEED TO TEST!)
    const activeCollections = await getCollectionsByIndex('isActive', true);
    const workTagged = await getCollectionsByIndex('tags', 'work');

    return {
      activeCount: activeCollections.length,
      workCount: workTagged.length,
      activeNames: activeCollections.map(c => c.name)
    };
  });

  // Assertions
  expect(result.activeCount).toBe(1);
  expect(result.workCount).toBe(1);
  expect(result.activeNames).toContain('Active Collection');
});
```

### Selection Service Usage Pattern

```javascript
import { selectCollections } from './services/selection/selectCollections.js';

// Filter active collections with 'work' tag, sorted by last accessed
const collections = await selectCollections({
  isActive: true,
  tags: ['work'],
  sortBy: 'lastAccessed',
  sortOrder: 'desc'
});
```

---

## Project Context

### What TabTaskTick Is
TabTaskTick evolves TabMaster Pro from tab hygiene into work management:
- **Collections** = Persistent windows (can be saved/restored)
- **Folders** = Chrome tab groups (topical organization)
- **Tabs** = Resources with notes
- **Tasks** = Work items referencing specific tabs in a collection

### Architecture Philosophy
- Services-first (no logic in UI)
- No dynamic imports (Chrome limitation)
- Normalized data model (no race conditions)
- Storage utilities not services (data access layer)
- Selection vs Execution separation

### Timeline
- **Phase 1**: âœ… Complete (6-8h actual)
- **Phase 2.1**: âœ… Complete (3-4h actual)
- **Phase 2.1.5**: âœ… Complete (4-5h actual)
- **Phase 2.2-2.6**: ðŸ”´ Not started (~10-12h remaining)
- **Total MVP**: 68-84 hours estimated

---

## Session Startup Instructions

When starting a new session, provide this context and ask:

**"I'm continuing work on TabTaskTick Phase 2. Here's where we are:**

**Status**: Phase 2.1 (Selection Services) complete. Playwright E2E testing infrastructure complete.

**Problem Solved**: Migrated from fake-indexeddb (broken index queries) to Playwright with real Chrome IndexedDB. Smoke tests passing (3/3).

**Immediate Task**: Write Playwright E2E tests for selectCollections and selectTasks to validate IndexedDB index queries work correctly in production. These tests are CRITICAL because fake-indexeddb couldn't validate the core functionality of selection services.

**After That**: Phase 2.2 - CollectionService implementation.

**Question**: Should I proceed with writing the E2E tests for selection services, or is there something else you'd like me to focus on?"**

---

## Quick Reference

### Most Important Files to Understand
1. `/services/selection/selectCollections.js` - Collection filtering logic
2. `/services/selection/selectTasks.js` - Task filtering logic
3. `/services/utils/storage-queries.js` - CRUD operations (getCollectionsByIndex, etc.)
4. `/tests/e2e/fixtures/extension.js` - Test fixtures and patterns
5. `/docs/playwright-testing.md` - Complete testing guide

### Most Important Commands
```bash
npm run test:e2e:headed     # Watch E2E tests in browser
npm test                    # Run Jest unit tests
```

### Most Important Architecture Rules
1. Use `testPage` fixture for ES module imports (not `serviceWorkerPage`)
2. All IndexedDB index queries MUST be tested with Playwright
3. Services call storage utilities (never direct IndexedDB access)
4. Keep workers: 1 in playwright.config.js (avoid profile conflicts)

---

## End of Context

This document contains everything needed to start a productive session on TabTaskTick Phase 2. The immediate priority is writing E2E tests for selection services to validate index queries work correctly, then moving on to Phase 2.2 (CollectionService).
